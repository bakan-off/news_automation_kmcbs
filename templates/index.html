<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>Отправка новости</title>
</head>
<body>
    <h1>Отправка новости</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% if session['logged_in'] %}
      <form action="/submit_news" method="post" enctype="multipart/form-data">
          <label for="title">Название новости:</label>
          <input type="text" id="title" name="title" required><br>

          <label for="age_rating">Возрастной ценз:</label>
          <input type="text" id="age_rating" name="age_rating" required><br>

          <label for="description">Описание:</label><br>
          <textarea id="description" name="description" rows="5" required></textarea><br>

          <label for="author">Автор или библиотека:</label>
          <input type="text" id="author" name="author" required><br>

          <label for="hashtags">Хештеги:</label>
          <input type="text" id="hashtags" name="hashtags"><br>

          <label for="file-upload" class="custom-file-upload">Выберите файлы</label>
          <input id="file-upload" type="file" name="files" multiple style="display: none;" onchange="updateFileList();"/>
          <button type="button" class="upload-button" onclick="document.getElementById('file-upload').click();">Выбрать файлы</button><br>

          <div id="filedrag">Или перетащите их сюда</div>
          <ul id="file-list"></ul>

          <button type="submit">Отправить</button>
      </form>
      <a href="/logout">Выйти</a>
    {% else %}
      <h2>Авторизация</h2>
      <form action="/login" method="post">
          <label for="user_cod">Логин:</label>
          <input type="text" id="user_cod" name="user_cod" required><br>

          <label for="password_cod">Пароль:</label>
          <input type="password" id="password_cod" name="password_cod" required><br>

          <button type="submit">Войти</button>
      </form>
    {% endif %}

    <script>
    let filesArray = [];

    function $id(id) {
        return document.getElementById(id);
    }

    function Output(msg) {
        const m = $id("messages");
        m.innerHTML = msg + m.innerHTML;
    }

    if (window.File && window.FileList && window.FileReader) {
        Init();
    }

    function Init() {
        const fileselect = $id("file-upload");
        const filedrag = $id("filedrag");

        fileselect.addEventListener("change", FileSelectHandler, false);
        filedrag.addEventListener("dragover", FileDragHover, false);
        filedrag.addEventListener("dragleave", FileDragHover, false);
        filedrag.addEventListener("drop", FileSelectHandler, false);
        filedrag.style.display = "block";
    }

    function FileDragHover(e) {
        e.stopPropagation();
        e.preventDefault();
        e.target.className = (e.type === "dragover" ? "hover" : "");
    }

    function FileSelectHandler(e) {
        FileDragHover(e);
        const files = e.target.files || e.dataTransfer.files;
        for (let i = 0; i < files.length; i++) {
            AddFileToInput(files[i]);
        }
    }

    function AddFileToInput(file) {
        // Проверяем, есть ли файл уже в массиве
        if (!filesArray.some(f => f.name === file.name)) {
            filesArray.push(file); // Добавляем файл в массив
        }

        // Обновляем input.files
        const dataTransfer = new DataTransfer();
        filesArray.forEach(f => dataTransfer.items.add(f));
        $id('file-upload').files = dataTransfer.files;

        // Обновляем список файлов
        updateFileList();
    }

    function updateFileList() {
        const fileList = $id('file-list');
        fileList.innerHTML = ''; // Очистить предыдущий список файлов

        filesArray.forEach(file => {
            const li = document.createElement('li');
            li.textContent = file.name; // Отобразить имя файла
            fileList.appendChild(li);
        });
    }
    </script>
</body>
</html>
